<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

  <!-- ãƒ•ã‚©ãƒ³ãƒˆ & ã‚¢ã‚¤ã‚³ãƒ³ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body {
      margin:0;
      font-family:'Noto Sans JP',sans-serif;
      background:#f5f7fb;
      color:#111827;
    }

    header {
      padding:20px;
      background:white;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .title {
      font-size:22px;
      font-weight:700;
    }
    .subtitle {
      margin-top:4px;
      font-size:12px;
      color:#6b7280;
    }

    .container {
      max-width:1100px;
      margin:30px auto;
      padding:0 20px;
    }

    /* ========= ã‚«ãƒ¼ãƒ‰ ========= */
    .stats {
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:16px;
    }

    .stat-card {
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 4px rgba(0,0,0,0.06);
    }

    .stat-title {
      font-size:14px;
      color:#6b7280;
      margin-bottom:6px;
    }
    .stat-value {
      font-size:26px;
      font-weight:700;
      color:#2563eb;
    }

    /* ========= æœŸé–“ä¸€è¦§ ========= */
    .periods-title {
      margin-top:30px;
      font-size:18px;
      font-weight:700;
    }

    .no-period {
      text-align:center;
      padding:60px 0;
      color:#6b7280;
    }

    .create-btn {
      padding:10px 16px;
      background:#4f46e5;
      color:white;
      border:none;
      border-radius:8px;
      font-size:14px;
      cursor:pointer;
    }

    /* ========== æœŸé–“ã‚«ãƒ¼ãƒ‰ ========== */
    .period-card {
      background:white;
      border-radius:12px;
      padding:20px;
      box-shadow:0 2px 4px rgba(0,0,0,0.06);
      margin-top:20px;
    }

    .period-header {
      font-size:20px;
      font-weight:700;
      display:flex;
      justify-content:space-between;
    }

    .badge {
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      color:white;
    }
    .badge.open { background:#16a34a; }
    .badge.locked { background:#eab308; }
    .badge.closed { background:#6b7280; }

    .period-info {
      margin-top:10px;
      font-size:14px;
      line-height:1.7;
    }

    .period-actions {
      margin-top:20px;
      display:flex;
      gap:12px;
    }

    .action-btn {
      padding:8px 14px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-size:14px;
    }
    .view-btn { background:#2563eb; color:white; }
    .edit-btn { background:#e5e7eb; }
    .delete-btn { background:#fca5a5; color:white; }

    /* ========= ãƒ¢ãƒ¼ãƒ€ãƒ« ========= */
    .modal-bg {
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.3);
      display:none;
      align-items:center;
      justify-content:center;
    }

    .modal {
      background:white;
      width:95%;
      max-width:480px;
      padding:24px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }

    .modal-title {
      font-size:18px;
      font-weight:700;
      margin-bottom:20px;
    }

    .form-group {
      margin-bottom:16px;
    }

    .form-group label {
      font-size:14px;
      font-weight:600;
      display:block;
      margin-bottom:6px;
    }

    input[type="text"],
    input[type="date"] {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
    }

    .modal-footer {
      text-align:right;
      margin-top:20px;
    }

    .modal-close {
      position:absolute;
      top:14px;
      right:16px;
      font-size:18px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>
  <div>
    <div class="title">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="subtitle">ã‚·ãƒ•ãƒˆæœŸé–“ã®ç®¡ç†ã¨å¾“æ¥­å“¡ã®æå‡ºçŠ¶æ³ç¢ºèª</div>
  </div>

  <button class="create-btn" onclick="openCreateModal()">
    <i class="fa-solid fa-plus"></i> æ–°è¦æœŸé–“ä½œæˆ
  </button>
</header>

<div class="container">

  <!-- ---- çµ±è¨ˆ ---- -->
  <div class="stats">
    <div class="stat-card">
      <div class="stat-title">ã‚·ãƒ•ãƒˆæœŸé–“</div>
      <div class="stat-value" id="statPeriodCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">å¾“æ¥­å“¡æ•°</div>
      <div class="stat-value" id="statUserCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">å‹Ÿé›†ä¸­</div>
      <div class="stat-value" id="statOpenCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">ç¢ºå®šæ¸ˆã¿</div>
      <div class="stat-value" id="statClosedCount">0</div>
    </div>
  </div>

  <div class="periods-title">ã‚·ãƒ•ãƒˆæœŸé–“ä¸€è¦§</div>

  <div id="periodList"></div>

</div>

<!-- ==============================
 ãƒ¢ãƒ¼ãƒ€ãƒ«
=============================== -->
<div class="modal-bg" id="modalBg">
  <div class="modal">

    <div class="modal-close" onclick="closeModal()">Ã—</div>
    <div class="modal-title">æ–°è¦ã‚·ãƒ•ãƒˆæœŸé–“ã‚’ä½œæˆ</div>

    <div class="form-group">
      <label>æœŸé–“å</label>
      <input type="text" id="periodName" placeholder="ä¾‹ï¼š2024å¹´1æœˆã‚·ãƒ•ãƒˆ">
    </div>

    <div class="form-group">
      <label>é–‹å§‹æ—¥</label>
      <input type="date" id="startDate">
    </div>

    <div class="form-group">
      <label>çµ‚äº†æ—¥</label>
      <input type="date" id="endDate">
    </div>

    <div class="form-group">
      <label>æå‡ºç· åˆ‡æ—¥</label>
      <input type="date" id="deadline">
    </div>

    <div class="modal-footer">
      <button class="create-btn" onclick="createPeriod()">ä½œæˆ</button>
    </div>

  </div>
</div>


<script>
const STORE = window.location.pathname.split("/")[1];

// ========= ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ =========
function openCreateModal() {
  document.getElementById("modalBg").style.display = "flex";
}
function closeModal() {
  document.getElementById("modalBg").style.display = "none";
}

// ========= æœŸé–“ä½œæˆ =========
async function createPeriod() {
  const name = document.getElementById("periodName").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const dl = document.getElementById("deadline").value;

  if (!name || !start || !end || !dl) {
    alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const res = await fetch(`/${STORE}/shift-period/create`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      name,
      startDate:start,
      endDate:end,
      deadline:dl
    })
  });

  const json = await res.json();
  if (json.status === "ok") {
    closeModal();
    loadPeriods();
  } else {
    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ========= æœŸé–“ä¸€è¦§å–å¾— =========
async function loadPeriods() {
  const res = await fetch(`/${STORE}/shift-period/list`);
  const periods = await res.json();

  document.getElementById("statPeriodCount").textContent = periods.length;

  // çŠ¶æ…‹åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
  const openCount = periods.filter(p => p.status === "open").length;
  const closedCount = periods.filter(p => p.status !== "open").length;
  document.getElementById("statOpenCount").textContent = openCount;
  document.getElementById("statClosedCount").textContent = closedCount;

  const list = document.getElementById("periodList");
  list.innerHTML = "";

  if (periods.length === 0) {
    list.innerHTML = `
      <div class="no-period">
        <div style="font-size:40px; margin-bottom:14px;">ğŸ“…</div>
        ã‚·ãƒ•ãƒˆæœŸé–“ãŒã‚ã‚Šã¾ã›ã‚“<br><br>
        <button class="create-btn" onclick="openCreateModal()">æœ€åˆã®æœŸé–“ã‚’ä½œæˆ</button>
      </div>`;
    return;
  }

  periods.forEach(p => {
    const badgeClass = p.status === "open" ? "open" : p.status === "locked" ? "locked" : "closed";

    list.innerHTML += `
      <div class="period-card">
        <div class="period-header">
          ${p.name}
          <span class="badge ${badgeClass}">
            ${p.status === "open" ? "å‹Ÿé›†ä¸­" :
               p.status === "locked" ? "èª¿æ•´ä¸­" : "ç¢ºå®šæ¸ˆã¿"}
          </span>
        </div>

        <div class="period-info">
          æœŸé–“: ${p.startDate} ã€œ ${p.endDate}<br>
          ç· åˆ‡: ${p.deadline}
        </div>

        <div class="period-actions">
          <button class="action-btn view-btn" onclick="location.href='/${STORE}/shift-admin/${p.id}'">
            ğŸ‘ ã‚·ãƒ•ãƒˆç®¡ç†
          </button>
          <button class="action-btn edit-btn">âœ ç·¨é›†</button>
          <button class="action-btn delete-btn">ğŸ—‘ å‰Šé™¤</button>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="action-btn" onclick="changeStatus('open')">å‹Ÿé›†ä¸­ã«å¤‰æ›´</button>
        <button class="action-btn" onclick="changeStatus('locked')">èª¿æ•´ä¸­ã«å¤‰æ›´</button>
        <button class="action-btn" style="background:#4caf50;color:white;" onclick="changeStatus('closed')">
            ç¢ºå®šæ¸ˆã¿ã«å¤‰æ›´
        </button>
        </div>

      </div>`;
  });
}

async function changeStatus(newStatus) {
  if (!confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  const res = await fetch(`/${STORE}/shift-period/${PERIOD_ID}/status`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: newStatus })
  });

  const json = await res.json();
  if (json.status === "ok") {
    alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
    loadDetail(); // è¡¨ç¤ºæ›´æ–°
  } else {
    alert("å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

loadPeriods();
</script>

</body>
</html>
