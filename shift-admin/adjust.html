<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>シフト調整（管理者）</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  body {
    margin:0;
    font-family:'Noto Sans JP',sans-serif;
    background:#f5f7fb;
  }
  header {
    background:white;
    padding:16px 20px;
    box-shadow:0 2px 4px rgba(0,0,0,0.05);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .title { font-size:20px; font-weight:700; }
  .subtitle { font-size:13px; color:#6b7280; margin-top:4px; }

  .container {
    max-width:1100px;
    margin:24px auto;
    padding:0 20px;
  }

  .employee-block {
    background:white;
    margin-bottom:22px;
    padding:20px;
    border-radius:12px;
    box-shadow:0 2px 4px rgba(0,0,0,0.06);
  }
  .employee-header {
    font-size:16px;
    font-weight:700;
    margin-bottom:12px;
  }
  .calendar {
    width:100%;
    border-collapse:collapse;
  }
  th {
    background:#f3f4f6;
    padding:6px;
    font-size:12px;
    color:#6b7280;
  }
  td {
    border:1px solid #e5e7eb;
    padding:4px;
    min-height:60px;
    vertical-align:top;
    position:relative;
  }

  .shift-tag {
    padding:4px 6px;
    background:#dbeafe;
    border-radius:6px;
    font-size:11px;
    margin-bottom:3px;
    display:block;
    cursor:pointer;
    color:#1e40af;
  }

  /* ===== モーダル ===== */
  .modal-bg {
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.3);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100;
  }
  .modal {
    background:white;
    padding:20px;
    width:90%;
    max-width:420px;
    border-radius:12px;
    position:relative;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
  }
  .modal-close {
    position:absolute;
    top:12px;right:14px;
    font-size:18px;
    cursor:pointer;
  }
  .modal-title {
    font-size:17px;
    font-weight:700;
    margin-bottom:14px;
  }

  .time-row {
    display:flex;
    gap:8px;
    margin-bottom:14px;
  }
  input[type="time"] {
    width:48%;
    padding:10px;
    border-radius:8px;
    border:1px solid #d1d5db;
  }

  .delete-btn {
    background:#fee2e2;
    border:none;
    padding:8px 12px;
    color:#b91c1c;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    margin-bottom:12px;
  }

  .save-btn {
    background:#4f46e5;
    border:none;
    padding:12px;
    border-radius:8px;
    color:white;
    width:100%;
    font-size:14px;
    cursor:pointer;
    margin-top:10px;
  }

  /* ★ 管理者のシフト追加ボタン */
  .add-btn-admin {
    background:#fbbf24;
    border:none;
    padding:10px;
    color:#78350f;
    width:100%;
    font-size:14px;
    cursor:pointer;
    border-radius:8px;
    margin-bottom:12px;
    font-weight:600;
  }

  .final-save {
    margin-top:24px;
    padding:14px;
    background:#16a34a;
    border:none;
    color:white;
    border-radius:10px;
    font-size:16px;
    cursor:pointer;
    width:100%;
  }
</style>
</head>
<body>

<header>
  <div>
    <div class="title">シフト調整</div>
    <div class="subtitle" id="headerSub"></div>
  </div>
  <button onclick="location.href='javascript:history.back()'">戻る</button>
</header>

<div class="container">

  <div id="employeeArea"></div>

  <button class="final-save" onclick="saveFinalShifts()">この期間のシフトを確定する</button>

</div>


<!-- ========== モーダル ========== -->
<div class="modal-bg" id="modalBg">
  <div class="modal">

    <div class="modal-close" onclick="closeModal()">×</div>
    <div class="modal-title" id="modalTitle">-</div>

    <!-- ★ 管理者用：シフト追加 -->
    <button class="add-btn-admin" onclick="addAdminShift()">＋ シフトを追加（管理者）</button>

    <div id="shiftListArea"></div>

    <button class="save-btn" onclick="saveAdminSubmission()">保存</button>
  </div>
</div>

<script>
  const STORE = location.pathname.split("/")[1];
  const periodId = location.pathname.split("/")[3];

  let periodInfo = null;
  let submissions = [];
  let staffList = [];

  let selectedUser = null;
  let selectedDate = null;

  // ==============================
  // 初期ロード
  // ==============================
  async function loadData(){
    const [pRes, sRes, staffRes] = await Promise.all([
      fetch(`/${STORE}/shift-period/${periodId}`),
      fetch(`/${STORE}/shift-period/${periodId}/submissions`),
      fetch(`/${STORE}/admin/search-staff`)
    ]);

    periodInfo = await pRes.json();
    submissions = await sRes.json();
    staffList = (await staffRes.json()).filter(s => s.approved);

    document.getElementById("headerSub").textContent =
      `${periodInfo.name}（${periodInfo.startDate} 〜 ${periodInfo.endDate}）`;

    buildEmployeeTables();
  }

  // ==============================
  // カレンダー生成
  // ==============================
  function buildEmployeeTables() {
    const area = document.getElementById("employeeArea");
    area.innerHTML = "";

    const start = new Date(periodInfo.startDate);
    const end = new Date(periodInfo.endDate);

    staffList.forEach(staff => {
      const submit = submissions.find(s => s.userId === staff.id);
      const shiftMap = submit?.shifts || {};

      let html = `
        <div class="employee-block">
          <div class="employee-header">${staff.name}</div>
          <table class="calendar">
            <thead>
              <tr>
                <th>日</th><th>月</th><th>火</th><th>水</th>
                <th>木</th><th>金</th><th>土</th>
              </tr>
            </thead>
            <tbody>
      `;

      let temp = new Date(start);
      let row = "<tr>";

      for (let i=0; i<temp.getDay(); i++) row += "<td></td>";

      while (temp <= end) {
        const dateStr = temp.toISOString().split("T")[0];
        const shifts = shiftMap[dateStr] || [];

        row += `<td>`;
        shifts.forEach((s, index) => {
          row += `<span class="shift-tag"
                     onclick="openModal('${staff.id}','${dateStr}')">
                     ${s.start}〜${s.end}
                  </span>`;
        });
        row += `</td>`;

        if (temp.getDay() === 6) {
          html += row + "</tr>";
          row = "<tr>";
        }

        temp.setDate(temp.getDate()+1);
      }

      html += row + "</tr></tbody></table></div>";
      area.innerHTML += html;
    });
  }

  // ==============================
  // モーダル（管理者）
  // ==============================
  function openModal(userId, date) {
    selectedUser = userId;
    selectedDate = date;

    buildShiftListAdmin();
    document.getElementById("modalTitle").textContent =
      `${userId}｜${date}`;
    document.getElementById("modalBg").style.display = "flex";
  }

  function closeModal(){
    document.getElementById("modalBg").style.display = "none";
  }

  // ==============================
  // 管理者：シフト一覧描画
  // ==============================
  function buildShiftListAdmin() {
    const area = document.getElementById("shiftListArea");
    area.innerHTML = "";

    const staff = submissions.find(s => s.userId === selectedUser);
    if (!staff.shifts[selectedDate]) staff.shifts[selectedDate] = [];

    staff.shifts[selectedDate].forEach((shift, index) => {
      area.innerHTML += renderShiftBlockAdmin(shift, index);
    });
  }

  // ==============================
  // 管理者：シフトブロック
  // ==============================
  function renderShiftBlockAdmin(shift, index) {
    return `
      <div class="shift-block">
        <div class="shift-header">
          シフト ${index+1}
          <span class="delete-btn" onclick="adminDeleteShift(${index})">削除</span>
        </div>

        <div class="time-row">
          <input type="time" id="start-${index}" value="${shift.start}">
          <input type="time" id="end-${index}" value="${shift.end}">
        </div>

        <div class="time-row">
          <input type="range" min="0" max="1439"
            value="${timeToMin(shift.start)}"
            onchange="adminDragStart(${index},this.value)">
          <input type="range" min="0" max="1439"
            value="${timeToMin(shift.end)}"
            onchange="adminDragEnd(${index},this.value)">
        </div>
      </div>
    `;
  }

  // ==============================
  // 時間変換
  // ==============================
  function timeToMin(t) {
    const [h,m]=t.split(":").map(Number);
    return h*60+m;
  }
  function minToTime(min) {
    const h=String(Math.floor(min/60)).padStart(2,"0");
    const m=String(min%60).padStart(2,"0");
    return `${h}:${m}`;
  }

  // ==============================
  // 管理者：追加
  // ==============================
  function addAdminShift() {
    const staff = submissions.find(s => s.userId === selectedUser);
    if (!staff.shifts[selectedDate]) staff.shifts[selectedDate] = [];

    staff.shifts[selectedDate].push({
      start:"09:00",
      end:"18:00"
    });

    buildShiftListAdmin();
  }

  // ==============================
  // 管理者：ドラッグ変更
  // ==============================
  function adminDragStart(index,val){
    const staff = submissions.find(s => s.userId === selectedUser);
    const t = minToTime(Number(val));
    document.getElementById(`start-${index}`).value = t;
    staff.shifts[selectedDate][index].start = t;
  }
  function adminDragEnd(index,val){
    const staff = submissions.find(s => s.userId === selectedUser);
    const t = minToTime(Number(val));
    document.getElementById(`end-${index}`).value = t;
    staff.shifts[selectedDate][index].end = t;
  }

  // ==============================
  // 管理者：削除
  // ==============================
  function adminDeleteShift(index){
    const staff = submissions.find(s => s.userId === selectedUser);
    staff.shifts[selectedDate].splice(index,1);
    buildShiftListAdmin();
  }

  // ==============================
  // 管理者：保存
  // ==============================
  async function saveAdminSubmission(){
    const staff = submissions.find(s => s.userId === selectedUser);

    const res = await fetch(`/${STORE}/shift-admin/update-submission/${periodId}/${selectedUser}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ shifts: staff.shifts })
    });

    const json = await res.json();
    if(json.status==="ok"){
      alert("保存しました！");
      closeModal();
      loadData();
    } else {
      alert("保存に失敗しました");
    }
  }

  // ==============================
  // final 保存
  // ==============================
  async function saveFinalShifts(){
    const finalData = {};

    submissions.forEach(s => {
      finalData[s.userId] = s.shifts;
    });

    const res = await fetch(`/${STORE}/shift-final/save`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        periodId,
        finalData
      })
    });

    const json = await res.json();
    if (json.status === "ok") {
      alert("この期間のシフトを確定しました！");
      location.reload();
    } else {
      alert("保存に失敗しました");
    }
  }

  loadData();
</script>

</body>
</html>
